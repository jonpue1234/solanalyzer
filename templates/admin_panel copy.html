<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h2>Admin Panel</h2>
        <a href="{{ url_for('admin_logout') }}">Logout</a>
        <div id="wallet-status" class="wallet-status">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Phantom Logo">
            <span id="wallet-address">Not connected</span>
            <button id="connect-button" class="btn-connect-wallet">Connect Wallet</button>
            <button id="disconnect-button" class="btn-disconnect-wallet" style="display: none;">Disconnect</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Subscription Expiration</th>
                    <th>Referral Fee</th>
                    <th>Withdraw Wallet</th>
                    <th>Update Subscription</th>
                    <th>Update Referral Fee</th>
                    <th>Pay Fee</th>
                    <th>Delete User</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.subscription_expiration }}</td>
                    <td>{{ user.referral_fee }} SOL</td>
                    <td>{{ user.wallet_address }}</td>
                    <td>
                        <form action="{{ url_for('admin_update_subscription') }}" method="POST">
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            <input type="number" name="days" placeholder="Days">
                            <button type="submit">Update</button>
                        </form>
                    </td>
                    <td>
                        <form action="{{ url_for('admin_update_referral_fee') }}" method="POST">
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            <input type="number" step="0.01" name="referral_fee" placeholder="Referral Fee">
                            <button type="submit">Update</button>
                        </form>
                    </td>
                    <td>
                        <button class="pay-fee-button" data-wallet="{{ user.wallet_address }}" data-fee="{{ user.referral_fee }}" data-user="{{ user.id }}">Pay Fee</button>
                    </td>
                    <td>
                        <form action="{{ url_for('admin_delete_user') }}" method="POST" onsubmit="return confirm('Are you sure you want to delete the user?');">
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            <button type="submit">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.24.0/dist/web3.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://cdn.socket.io/4.1.3/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Asegúrate de que solanaWeb3 está disponible antes de usarla
            if (typeof solanaWeb3 !== 'undefined') {
                const connection = new solanaWeb3.Connection('https://serene-damp-glitter.solana-mainnet.quiknode.pro/67bc037e49576cd54c3e579a9ff70f59bc77e8f5/');
                const connectButton = document.getElementById('connect-button');
                const disconnectButton = document.getElementById('disconnect-button');
                const walletStatus = document.getElementById('wallet-status');
                const walletAddress = document.getElementById('wallet-address');

                async function connectWallet(event) {
                    event.stopPropagation();
                    console.log("Connect button clicked");
                    const provider = window.phantom?.solana;
                    if (provider?.isPhantom) {
                        try {
                            const resp = await provider.connect();
                            const publicKey = resp.publicKey.toString();
                            console.log('Connected with Public Key:', publicKey);

                            walletAddress.textContent = publicKey;
                            walletStatus.style.display = 'flex';
                            disconnectButton.style.display = 'inline-block';

                            // Guardar en sessionStorage
                            sessionStorage.setItem('walletphantom', publicKey);

                            const response = await fetch('/connect_wallet', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ publicKey: publicKey })
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data.status === 'success') {
                                    console.log(data.message);
                                } else {
                                    console.error('Error:', data.message);
                                }
                            } else {
                                const errorText = await response.text();
                                console.error('HTTP Error:', response.statusText, errorText);
                            }
                        } catch (err) {
                            console.error('Connection failed!', err);
                        }
                    } else {
                        alert('Phantom Wallet is not installed. Please install it from https://phantom.app/');
                    }
                }

                if (connectButton) {
                    connectButton.addEventListener('click', connectWallet);
                } else {
                    console.log("Connect button not found");
                }

                if (disconnectButton) {
                    disconnectButton.addEventListener('click', async (event) => {
                        event.stopPropagation();
                        console.log("Disconnect button clicked");
                        const provider = window.phantom?.solana;
                        if (provider?.isPhantom) {
                            try {
                                // Desconectar la wallet de la extensión Phantom
                                await provider.disconnect();

                                // Actualizar el estado en el frontend
                                walletAddress.textContent = 'Not connected';
                                walletStatus.style.display = 'none';
                                disconnectButton.style.display = 'none';

                                // Eliminar de sessionStorage
                                sessionStorage.removeItem('walletphantom');

                                // Limpiar otras posibles cookies/sesiones relacionadas
                                document.cookie.split(";").forEach(function(c) { 
                                    document.cookie = c.trim().split("=")[0] + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/"; 
                                });

                                // Llamar al endpoint de desconexión en el backend
                                const response = await fetch('/disconnect_wallet', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });

                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.status === 'success') {
                                        console.log(data.message);
                                    } else {
                                        console.error('Error:', data.message);
                                    }
                                } else {
                                    const errorText = await response.text();
                                    console.error('HTTP Error:', response.statusText, errorText);
                                }

                                // Recargar la página para limpiar cualquier caché residual
                                location.reload();
                            } catch (err) {
                                console.error('Disconnection failed!', err); 
                            }
                        }
                    });
                } else {
                    console.log("Disconnect button not found");
                }
                
                const walletphantom = sessionStorage.getItem('walletphantom');
                if (walletphantom) {
                    walletAddress.textContent = walletphantom;
                    walletStatus.style.display = 'flex';
                    disconnectButton.style.display = 'inline-block';
                }

                const payFeeButtons = document.querySelectorAll('.pay-fee-button');
                payFeeButtons.forEach(button => {
                    button.addEventListener('click', async function () {
                        const userWallet = this.getAttribute('data-wallet');
                        const fee = parseFloat(this.getAttribute('data-fee'));
                        const userId = this.getAttribute('data-user');

                        if (!walletAddress.textContent || walletAddress.textContent === 'Not connected') {
                            alert('Please connect the admin wallet first.');
                            return;
                        }

                        const provider = window.phantom?.solana;
                        if (provider?.isPhantom) {
                            try {
                                const { blockhash } = await connection.getLatestBlockhash();
                                const transaction = new solanaWeb3.Transaction({
                                    feePayer: provider.publicKey,
                                    recentBlockhash: blockhash,
                                }).add(
                                    solanaWeb3.SystemProgram.transfer({
                                        fromPubkey: provider.publicKey,
                                        toPubkey: new solanaWeb3.PublicKey(userWallet),
                                        lamports: solanaWeb3.LAMPORTS_PER_SOL * fee
                                    })
                                );

                                const signedTransaction = await provider.signTransaction(transaction);
                                const signature = await connection.sendRawTransaction(signedTransaction.serialize());
                                await connection.confirmTransaction(signature, 'processed');
                                console.log('Fee paid successfully:', signature);

                                const response = await fetch('/pay_fee', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ user_id: userId, signature: signature })
                                });

                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.status === 'success') {
                                        console.log(data.message);
                                        location.reload();
                                    } else {
                                        console.error('Error:', data.message);
                                    }
                                } else {
                                    const errorText = await response.text();
                                    console.error('HTTP Error:', response.statusText, errorText);
                                }
                            } catch (err) {
                                console.error('Transaction failed!', err);
                            }
                        } else {
                            alert('Phantom Wallet is not installed. Please install it from https://phantom.app/');
                        }
                    });
                });
            } else {
                console.error("solanaWeb3 is not defined. Make sure Solana Web3 library is loaded correctly.");
            }
        });
    </script>
</body>
</html>
