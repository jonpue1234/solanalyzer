<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SolAnalyzer{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght=400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.jpg') }}">

</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">
            <h1>
                <a href="{{ url_for('home') }}" class="title-link"><span class="highlight">Sol</span>Analyzer</a>
                <a href="https://t.me/Pueyo10" target="_blank">
                    <img src="{{ url_for('static', filename='img/telegram.png') }}" alt="Telegram" class="telegram-icon">
                </a>
            </h1>
        </div>
        {% if current_user.is_authenticated %}
            <div id="wallet-status" class="wallet-status">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Phantom Logo">
                <span id="wallet-address">Not connected</span>
                <button id="connect-button" class="btn-connect-wallet">Connect Wallet</button>
                <button id="disconnect-button" class="btn-disconnect-wallet" style="display: none;">Disconnect</button>
            </div>
        {% endif %}
    </nav>
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                    {% for category, message in messages %}
                        <li class="flash {{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.24.0/dist/web3.min.js"></script>
    <script src="https://cdn.socket.io/4.1.3/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const socket = io();

            socket.on('force_logout', function (data) {
                alert(data.message);
                window.location.href = "{{ url_for('login') }}";
            });

            const connectButton = document.getElementById('connect-button');
            const disconnectButton = document.getElementById('disconnect-button');
            const walletStatus = document.getElementById('wallet-status');
            const walletAddress = document.getElementById('wallet-address');

            async function connectWallet(event) {
                event.stopPropagation();
                const provider = window.phantom?.solana;
                if (provider?.isPhantom) {
                    try {
                        const resp = await provider.connect();
                        const publicKey = resp.publicKey.toString(); 
                        console.log('Connected with Public Key:', publicKey);

                        walletAddress.textContent = publicKey;
                        walletStatus.style.display = 'flex';
                        disconnectButton.style.display = 'inline-block';
                        connectButton.style.display = 'none';

                        // Guardar en sessionStorage
                        sessionStorage.setItem('walletphantom', publicKey);

                        const response = await fetch('/connect_wallet', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ publicKey: publicKey })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.status === 'success') {
                                console.log(data.message);
                            } else {
                                console.error('Error:', data.message);
                            }
                        } else {
                            const errorText = await response.text();
                            console.error('HTTP Error:', response.statusText, errorText);
                        }
                    } catch (err) {
                        console.error('Connection failed!', err);
                    }
                } else {
                    alert('Phantom Wallet is not installed. Please install it from https://phantom.app/');
                }
            }

            if (connectButton) {
                connectButton.addEventListener('click', connectWallet);
            }

            if (disconnectButton) {
                disconnectButton.addEventListener('click', async (event) => {
                    event.stopPropagation();
                    const provider = window.phantom?.solana;
                    if (provider?.isPhantom) {
                        try {
                            // Desconectar la wallet de la extensión Phantom
                            await provider.disconnect();

                            // Actualizar el estado en el frontend
                            walletAddress.textContent = 'Not connected';
                            disconnectButton.style.display = 'none';
                            connectButton.style.display = 'inline-block';

                            // Eliminar de sessionStorage
                            sessionStorage.removeItem('walletphantom');

                            // Limpiar otras posibles cookies/sesiones relacionadas
                            document.cookie.split(";").forEach(function(c) { 
                                document.cookie = c.trim().split("=")[0] + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/"; 
                            });

                            // Llamar al endpoint de desconexión en el backend
                            const response = await fetch('/disconnect_wallet', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data.status === 'success') {
                                    console.log(data.message);
                                } else {
                                    console.error('Error:', data.message);
                                }
                            } else {
                                const errorText = await response.text();
                                console.error('HTTP Error:', response.statusText, errorText);
                            }
                        } catch (err) {
                            console.error('Disconnection failed!', err);
                        }
                    }
                });
            }

            // Siempre mostrar los botones de conectar/desconectar
            walletAddress.textContent = 'Not connected';
            walletStatus.style.display = 'flex';
            disconnectButton.style.display = 'none';
            connectButton.style.display = 'inline-block';

            // Código para ocultar mensajes de flash después de 3 segundos
            setTimeout(function () {
                const flashMessages = document.querySelectorAll('.flash');
                flashMessages.forEach(function (message) {
                    message.style.transition = 'opacity 1s';
                    message.style.opacity = '0';
                    setTimeout(function () {
                        message.remove();
                    }, 1000); // Esperar a que la transición termine antes de eliminar el elemento
                });
            }, 3000); // 3000 milisegundos = 3 segundos
        });
    </script>
</body>
</html>
